
本番モードで起動する方法
========================

`kazaoki/genie` を使って開発してきたサービスを本番用に公開する方法は３つあります。

- genie コマンドで本番実行
- Docker Compose で本番実行
- コンテナをしないで本番実行

以下、それぞれ詳説します。


<br>

genie コマンドで本番実行
--------------------------

本番サーバに必要なファイルを配置し（gitで展開するのを推奨）、その中で genie を実行します。  
これが一番カンタンで、運用も genie コマンドが使えるのでお手軽ですが、融通が効かない場合があります。（細かいdockerの設定やスケールアウトなど）  
細かい調整を行いたいた場合は、後述の**「Docker Compose で本番実行」**を参照して下さい。  

```bash
$ genie up -m product
```

これで、実行モードが `product` （本番モード）として各コンテナが実行されます。
また、全コンテナの起動オプションに `--restart=always` が自動的に追加されます。

### 再起動する（同じコマンド）

```bash
$ genie up -m product
```

本番モードではオプション `-m product` が必須になりますので注意して下さい。未指定の場合は開発時と同じく実行モードが `develop` （開発モード）になります。（ `product-up.sh` なんかを作っておくといいかもです）  
その他コマンドは開発時と同様です。以下、運用で使いそうなコマンドを列挙してみます。

### 停止する

```bash
$ genie down
```

### DBをバックアップ/リストアする

```bash
$ genie mysql dump
$ genie mysql restore

$ genie psql dump
$ genie psql restore
```

### アプリケーションデプロイ
##### ソース更新後、コンテナ再起動

```bash
$ git pull
$ genie up -m product
```

`git pull` のみで更新されるコンテンツであれば再起動の必要はありませんが、上記コマンドのように `genie up` してコンテナを再起動する必要がある場合は、コンテナが一旦全て終了・削除されるため、ダウンタイムが発生します。

##### ソース更新後、サービスリロード

上記を回避したい場合、リロードの必要があるサービスのみにシグナルを送るといいです。
`.genie/config.pl` の `ADD_COMMAND` 設定に、リロードが必要なコマンドを用意しておくと便利です。

```perl
	# 追加コマンド設定
	# ----------------
	ADD_COMMAND => {
		graceful => '/usr/sbin/httpd -k graceful', # Apacheを素敵に再起動（ダウンタイム最小）
	},
```

```bash
$ git pull
$ genie graceful
```

ちなみに、 `genie up` による再起動は、DBコンテナも含め全て一旦終了しますが、DB用のボリュームが残りそのまま引き続き再利用されるので、ダンプSQLファイルが展開・ロールバックされることはありません。


<br><br><br>


Docker Compose で本番実行
-------------------------

現行の genie 用設定ファイル `.genie/config.pl` を元に、Docker Compose 用の設定ファイルを出力できますので、こちらを調整して利用することができます。
もちろん、 `.genie/config.pl` が修正された場合は再度出力・調整してください。

### Docker Compose 用の設定ファイルを生成する

```bash
$ genie compose > docker-compose.yml
```

設定をいじれば好きなだけ融通は効きますし、スケールアウトもできると思いますが、デプロイやDBのバックアップ・運用方法もご自分で用意する必要があります。（genie コマンドは使えません）  
あとは [Docker Compose のマニュアル](http://docs.docker.jp/compose/toc.html) に従ってご利用下さい。

### ご注意

- `docker-compose` コマンドにて、 `stop` 後に `up` すると、一部サービスが落ちてしまう場合があるようなので、しっかり `down` してから `up` し直す必要があるかもしれません。
- `genie compose` コマンドで出力された設定ファイルですと、 genie と同様にローカルのボリュームをリンクする形でコンテナが起動するため、Docker Swarm や Docker Machine 等を利用したリモートでの `up` がそのままではうまく機能しないでしょう。この場合、公開しているDockerイメージである `kazaoki/genie` をベースとした、アプリケーションソースを含めた独自のイメージを作成・ホストする必要があるかもしれません。もしくは、`.genie/genie/opt/init.sh` にて毎回 `git pull` する方法で対応できるかもしれません。
いずれにせよ、Docker Compose を利用する場合は大変覚悟して下さい。




<br><br><br>




コンテナをしないで本番実行
--------------------------


これでもアリです。
開発環境と同様のサーバをオンプレミスで用意し、Docker無しの環境にシステムを配置します。
ただ、この場合は genie コマンドはもちろん使えませんので、運用方法をよく考えて下さい。
